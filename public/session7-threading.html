<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Buổi 7 | Đa tuyến & Xử lý đồng thời</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Oswald">
  <link rel="stylesheet" href="/style.main.min.b8048638da11b2704c9ac4157cecae3c80b86dacaa16790b14b3a9f17eade743.css">
</head>
<body>
<nav class="topnav">
  <ul>
    <li><a href="/index.html">Trang chủ</a></li>
    <li><a href="/java-installation.html">Giới thiệu & Cài đặt Java</a></li>
    <li><a href="/session2-foundation.html">Kiến thức nền tảng</a></li>
    <li><a href="/session3-io.html">Quản lý luồng nhập/xuất</a></li>
    <li><a href="/session4-network-address.html">Quản lý địa chỉ mạng</a></li>
    <li><a href="/session5-tcp.html">Lập trình Sockets TCP</a></li>
    <li><a href="/session6-udp.html">Lập trình Socket UDP</a></li>
    <li><a href="/session7-threading.html">Đa tuyến & Xử lý đồng thời</a></li>
    <li><a href="/session8-rmi.html">Multicast UDP & Java RMI</a></li>
    <li><a href="/appendix-courses.html">Khóa học bổ trợ</a></li>
  </ul>
</nav>
<style>
.topnav {
  background-color: #222;
  overflow: hidden;
  text-align: center;
  margin-bottom: 20px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
.topnav ul {
  list-style-type: none;
  margin: 0;
  padding: 0;
  display: inline-block;
}
.topnav li {
  display: inline;
}
.topnav a {
  display: inline-block;
  color: white;
  text-align: center;
  padding: 14px 20px;
  text-decoration: none;
  font-family: 'Roboto', sans-serif;
}
.topnav a:hover {
  background-color: #575757;
  color: #fff;
}
.topnav a.active {
  background-color: #0078d7;
  color: white;
  border-radius: 3px;
}
</style>
<!-- Code font-size control toolbar -->
<div id="code-size-toolbar" style="position:fixed;right:18px;bottom:18px;background:rgba(0,0,0,0.6);color:#fff;padding:8px;border-radius:8px;z-index:9999;display:flex;gap:6px;align-items:center;font-family:Arial,Helvetica,sans-serif;">
  <button id="code-decrease" title="Giảm cỡ chữ" style="background:transparent;border:1px solid rgba(255,255,255,0.2);color:#fff;padding:6px 8px;border-radius:4px;cursor:pointer;">A-</button>
  <button id="code-reset" title="Reset" style="background:transparent;border:1px solid rgba(255,255,255,0.2);color:#fff;padding:6px 8px;border-radius:4px;cursor:pointer;">A</button>
  <button id="code-increase" title="Tăng cỡ chữ" style="background:transparent;border:1px solid rgba(255,255,255,0.2);color:#fff;padding:6px 8px;border-radius:4px;cursor:pointer;">A+</button>
</div>

<script>
  (function(){
    const root = document.documentElement;
    const key = 'codeFontSizeRem';
    const min = 0.6, max = 2.4, step = 0.1;
    function getSize(){ return parseFloat(localStorage.getItem(key)) || 1.0; }
    function setSize(v){ v = Math.min(max, Math.max(min, Math.round(v*10)/10)); localStorage.setItem(key, v); root.style.setProperty('--code-font-size', v + 'rem'); }
    // init
    setSize(getSize());
    document.getElementById('code-decrease').addEventListener('click', ()=> setSize(getSize()-step));
    document.getElementById('code-increase').addEventListener('click', ()=> setSize(getSize()+step));
    document.getElementById('code-reset').addEventListener('click', ()=> setSize(1.0));
  })();
</script>
<style>
  :root{
    --max-width: 1000px;
    --bg: #ddd;
    --card: #ffffff;
    --muted: #666;
    --accent: #e3bfb8;
    --radius: 12px;
    --shadow: 0 10px 30px rgba(102,102,102,0.12);
    --base-font: 18px;
  }

  body{ background: var(--bg); font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; color:#0b1220; font-size:var(--base-font); line-height:1.6; }

  .lesson-content{ max-width:var(--max-width); margin:28px auto; padding:28px; background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); }

  .lesson-content h1{ font-family: 'Oswald', 'Segoe UI', sans-serif; font-size:3rem; margin-bottom:10px; color:var(--accent); }
  .lesson-content h2{ font-size:2rem; margin-top:22px; color:#0b2a44; }

  .lesson-content ul{ margin-left:1.05rem; }

  .topnav a{ padding:16px 22px; font-size:1rem; }

  .lesson-content img{ display:block; width:100%; border-radius:8px; border:1px solid rgba(11,18,32,0.04); box-shadow:0 4px 12px rgba(9,18,28,0.04); margin-bottom:18px; }

  :root{ --code-font-size: 1rem; }
  pre{ background:#0b1220; color:#e6eef8; padding:20px; border-radius:10px; overflow:auto; font-family: 'Courier New', monospace; font-size:calc(var(--code-font-size) * 1.1); box-shadow:0 8px 24px rgba(2,6,23,0.25); }
  code{ background:rgba(2,6,23,0.06); padding:4px 8px; border-radius:6px; font-family: 'Courier New', monospace; font-size:var(--code-font-size); }

  .callout{ background: rgba(227,191,184,0.08); border-left:4px solid var(--accent); padding:12px 16px; border-radius:8px; margin-bottom:18px; }
  .callout p{ margin:0; font-size:1.15rem; color:#0b1220; }

  @media (max-width:640px){
    :root{ --base-font:18px; }
    .topnav ul{ display:block; }
    .topnav li{ display:block; }
    .topnav a{ display:block; padding:12px; }
    .lesson-content{ margin:14px; padding:18px; border-radius:10px; }
    .lesson-content h1{ font-size:2.2rem; }
  }
</style>
<style>
  .lesson-content b, .lesson-content strong { font-family: 'Oswald','Segoe UI',sans-serif; font-weight:700; color:#0b2a44; }
</style>

<div class="lesson-content">
  <h1>Buổi 7: Đa tuyến và Xử lý đồng thời</h1>

  <h2>Mục tiêu bài học</h2>
  <ul>
    <li>Hiểu mô hình thread, scheduling, khái niệm concurrency vs. parallelism.</li>
    <li>Tạo thread bằng <code>Thread</code>, <code>Runnable</code>, và quản lý bằng <code>ExecutorService</code>.</li>
    <li>Nắm cơ chế đồng bộ: <code>synchronized</code>, <code>volatile</code>, <code>Lock</code>, <code>Atomic*</code>, <code>BlockingQueue</code>.</li>
    <li>Áp dụng vào server chat đa tuyến: thread pool, broadcast, ghi log an toàn.</li>
    <li>Tránh bẫy thường gặp: race condition, deadlock, starvation; xử lý <code>interrupt</code> và shutdown an toàn.</li>
  </ul>

  <h2>1. Lý thuyết bổ sung</h2>
  <ul>
    <li><b>Thread lifecycle</b>: NEW → RUNNABLE → BLOCKED/WAITING/TIMED_WAITING → TERMINATED.</li>
    <li><b>Memory visibility</b>: dùng <code>volatile</code> hoặc đồng bộ để đảm bảo các thread nhìn thấy giá trị mới.</li>
    <li><b>synchronized</b>: khóa theo đối tượng/class; đảm bảo loại trừ lẫn nhau (mutual exclusion) và tính hiển thị bộ nhớ.</li>
    <li><b>Lock</b> (ReentrantLock): linh hoạt hơn synchronized (tryLock, interruptible lock).</li>
    <li><b>Atomic classes</b>: <code>AtomicInteger</code>, <code>AtomicLong</code>... hỗ trợ cập nhật không khóa cho các phép toán đơn giản.</li>
    <li><b>Executors</b>: quản lý thread pool (fixed, cached, scheduled). Giúp tái sử dụng thread, giới hạn số luồng hoạt động.</li>
    <li><b>BlockingQueue</b>: phối hợp producer-consumer; <code>put/take</code> chặn khi queue đầy/rỗng.</li>
  </ul>

  <div class="callout"><p>Ghi nhớ: Chốt giao thức I/O trước, sau đó chọn mô hình thread phù hợp (per-connection, thread pool, non-blocking). Đơn giản hóa chia sẻ trạng thái giữa các thread để giảm rủi ro đồng bộ.</p></div>

  <h2>2. Ví dụ — Chat Server đa tuyến với Thread Pool</h2>
  <p><b>Mã server (ChatServer.java)</b></p>
  <pre><code class="language-java">/*
 * Click nbfs://nbhost/SystemFileSystem/Templates/Licenses/license-default.txt to change this license
 */
package com.mycompany.chatserver;

import java.io.*;
import java.net.*;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.Enumeration;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;

public class ChatServer {
  private static final int PortNumber = 9999;
  private static final String LOG_FILE = "chat_log.txt";

  private static void displayServerIPAddress() {
    try {
      // Lấy địa chỉ Local IP của máy chủ
      Enumeration&lt;NetworkInterface&gt; networkInterfaces = NetworkInterface.getNetworkInterfaces();
      while (networkInterfaces.hasMoreElements()) {
        NetworkInterface networkInterface = networkInterfaces.nextElement();
        Enumeration&lt;InetAddress&gt; inetAddresses = networkInterface.getInetAddresses();
        while (inetAddresses.hasMoreElements()) {
          InetAddress inetAddress = inetAddresses.nextElement();
          // Lọc và tìm địa chỉ IP của giao diện Local (không phải loopback)
          if (!inetAddress.isLoopbackAddress() &amp;&amp; inetAddress.isSiteLocalAddress()) {
            String serverIP = inetAddress.getHostAddress();
            System.out.println("Địa chỉ IP của Server: " + serverIP);
          }
        }
      }
    } catch (SocketException e) {
      e.printStackTrace();
    }
  }

  public static void main(String[] args) {
    try {
      // Hiển thị địa chỉ IP của máy chủ
      displayServerIPAddress();

      ServerSocket serverSocket = new ServerSocket(PortNumber);
      System.out.println("Server is listening...");

      ArrayList&lt;ClientHandler3&gt; clientHandlers = new ArrayList&lt;&gt;();
      ExecutorService executor = Executors.newCachedThreadPool();

      while (true) {
        Socket clientSocket = serverSocket.accept();
        System.out.println("Client connected: " + clientSocket.getInetAddress());
        // Tạo thread xử lý client
        ClientHandler3 clientHandler = new ClientHandler3(clientSocket, clientHandlers);
        clientHandlers.add(clientHandler);
        executor.execute(clientHandler);
      }
    } catch (IOException e) {
      e.printStackTrace();
    }
  }

  public static synchronized void logMessage(String senderName, String message) {
    try (PrintWriter logWriter = new PrintWriter(new BufferedWriter(new FileWriter(LOG_FILE, true)))) {
      SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
      String timestamp = sdf.format(new Date());
      logWriter.println(timestamp + " - " + senderName + ": " + message);
    } catch (IOException e) {
      e.printStackTrace();
    }
  }
}

class ClientHandler3 implements Runnable {
  private Socket clientSocket;
  private String clientName;
  private BufferedReader in;
  private PrintWriter out;
  private ArrayList&lt;ClientHandler3&gt; clientHandlers;

  public ClientHandler3(Socket clientSocket, ArrayList&lt;ClientHandler3&gt; clientHandlers) {
    this.clientSocket = clientSocket;
    this.clientHandlers = clientHandlers;
  }

  public void run() {
    try {
      in = new BufferedReader(new InputStreamReader(clientSocket.getInputStream()));
      out = new PrintWriter(clientSocket.getOutputStream(), true);

      // Nhận tên client từ dòng đầu tiên
      clientName = in.readLine();
      System.out.println("Client name: " + clientName);

      // Đọc dữ liệu và broadcast tới các client khác
      while (true) {
        String message = in.readLine();
        if (message == null) break; // Client đóng kết nối

        if (message.equalsIgnoreCase("exit")) {
          broadcastMessage(clientName + " has exited the chat.");
          System.out.println(clientName + " has exited the chat.");
          break;
        }

        ChatServer.logMessage(clientName, message);
        broadcastMessage(clientName + ": " + message);
      }

      // Loại bỏ handler khỏi danh sách và đóng socket
      clientHandlers.remove(this);
      clientSocket.close();
    } catch (IOException e) {
      e.printStackTrace();
    }
  }

  public void broadcastMessage(String message) {
    for (ClientHandler3 clientHandler : clientHandlers) {
      clientHandler.sendMessage(message);
    }
  }

  public void sendMessage(String message) {
    out.println(message);
  }
}
</code></pre>

<h3>Kết quả khi chạy server</h3>
<pre><code>
Địa chỉ IP của Server: 192.168.1.100
Server is listening...
Client connected: /192.168.1.101
Client name: Alice
Client connected: /192.168.1.102
Client name: Bob
</code></pre>

<p><b>Mã client (ChatClient.java)</b></p>
  <pre><code class="language-java">/*
 * Click nbfs://nbhost/SystemFileSystem/Templates/Licenses/license-default.txt to change this license
 * Click nbfs://nbhost/SystemFileSystem/Templates/Classes/Class.java to edit this template
 */
package com.mycompany.chatserver;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.io.PrintWriter;
import java.net.Socket;

public class ChatClient {
  public static void main(String[] args) {
    try {
      final int PortNumber = 9999;
      BufferedReader inputReader = new BufferedReader(new InputStreamReader(System.in));

      // Lấy IP server từ bàn phím
      System.out.print("Enter Server IP Address: ");
      String serverIP = inputReader.readLine();

      // Tạo socket client
      Socket clientSocket = new Socket(serverIP, PortNumber);

      // Tạo lu���ng vào/ra
      BufferedReader in = new BufferedReader(new InputStreamReader(clientSocket.getInputStream()));
      PrintWriter out = new PrintWriter(clientSocket.getOutputStream(), true);

      // Nhập tên client
      System.out.print("Enter your name: ");
      String clientName = inputReader.readLine();

      // Gửi tên tới server
      out.println(clientName);

      // Luồng đọc từ server
      Thread readThread = new Thread(() -> {
        try {
          while (true) {
            String response = in.readLine();
            if (response == null) break; // Server đóng
            System.out.println(response);
          }
        } catch (IOException e) {
          e.printStackTrace();
        }
      });
      readThread.start();

      // Gửi dữ liệu tới server
      while (true) {
        String message = inputReader.readLine();
        out.println(message);
        if (message.equalsIgnoreCase("exit")) break;
      }

      // Đóng kết nối
      clientSocket.close();
    } catch (IOException e) {
      e.printStackTrace();
    }
  }
}
</code></pre>

<h3>Kết quả khi chạy client (nhập tên Alice và tin nhắn "Hello everyone")</h3>
<pre><code>
Enter Server IP Address: 192.168.1.100
Enter your name: Alice
Hello everyone
Alice: Hello everyone
Bob: Hi Alice!
</code></pre>

<h3>Giải thích chi tiết</h3>
  <ul>
    <li><b>ExecutorService (cached pool)</b>: tái sử dụng/khởi tạo luồng theo nhu cầu, phù hợp server chat có số client biến động.</li>
    <li><b>Broadcast</b>: mỗi thông điệp được chuyển tới mọi client bằng cách lặp qua danh sách handler đang hoạt động.</li>
    <li><b>Log an toàn</b>: <code>logMessage</code> đồng bộ để tránh ghi chồng chéo vào file <code>chat_log.txt</code>.</li>
    <li><b>Hiển thị IP máy chủ</b>: liệt kê các interface và địa chỉ site-local để hướng dẫn client kết nối.</li>
    <li><b>Thoát</b>: client gửi "exit" để rời phòng, server thông báo tới những người còn lại.</li>
  </ul>

  <h2>3. Đồng bộ hóa và an toàn luồng</h2>
  <ul>
    <li>Đồng bộ khi truy cập tài nguyên chia sẻ (ví dụ file log). Với danh sách client, cân nhắc dùng cấu trúc thread-safe khi mở rộng.</li>
    <li>Thiết kế giao thức I/O rõ ràng: dòng đầu tiên là tên, các dòng sau là tin nhắn; quy ước từ khóa "exit" để kết thúc.</li>
    <li>Đặt timeout đọc/ghi khi triển khai thực tế để tránh treo do client không phản hồi.</li>
  </ul>

  <h2>4. Lưu ý thường gặp</h2>
  <ul>
    <li>Giới hạn số lượng client đồng thời bằng thread pool hoặc cơ chế admission.</li>
    <li>Xử lý client rơi mạng: phát hiện <code>null</code> từ <code>readLine()</code> v�� dọn dẹp tài nguyên.</li>
    <li>Tránh deadlock bằng cách không giữ khóa khi thực hiện I/O mạng kéo dài.</li>
  </ul>

  <h2>Tổng kết</h2>
  <p>Bạn đã thay thế các ví dụ bằng một server chat đa tuyến và client tương ứng, minh họa rõ ràng cách dùng thread pool, broadcast và ghi log an toàn. Mẫu này là nền tảng để mở rộng các tính năng như phòng chat, danh sách người dùng, hoặc xác thực.</p>
</div>

<style>
  .pager{ max-width:var(--max-width); margin:10px auto 40px; padding:0 28px; display:flex; justify-content:space-between; align-items:center; }
  .pager a{ display:inline-block; background:#0078d7; color:#fff; padding:12px 18px; border-radius:8px; text-decoration:none; font-weight:600; box-shadow:0 4px 10px rgba(0,0,0,0.08); transition:background .2s ease, transform .1s ease; }
  .pager a:hover{ background:#005a9e; transform:translateY(-1px); }
  .pager a.disabled{ background:#b9c5d1; pointer-events:none; cursor:default; }
</style>
<div class="pager">
  <a class="prev" href="/session6-udp.html">← Trang trước</a>
  <a class="next" href="/session8-rmi.html">Trang sau →</a>
</div>
</body>
</html>